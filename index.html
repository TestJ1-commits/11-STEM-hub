<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>11-STEM by J1b - Class Hub</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Use Inter font family -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .section-card {
            background-color: white;
            border-radius: 1.5rem; /* Large rounded corners */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        /* Custom scrollbar for better look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #6366f1; /* Indigo-500 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 p-4 bg-white rounded-xl shadow-md">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 flex items-center justify-center bg-indigo-100 rounded-full text-indigo-600">
                    <i data-lucide="graduation-cap" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">11-STEM by J1b</h1>
                    <p class="text-sm text-gray-500">Official Class Hub</p>
                </div>
            </div>
            
            <div id="auth-ui" class="flex items-center space-x-4">
                <!-- User/Admin Status will be rendered here -->
            </div>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Announcements (Full Width on Mobile, 2/3 on Desktop) -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Welcome/Purpose Card -->
                <div class="section-card p-6 border-l-4 border-indigo-500">
                    <h2 class="text-xl font-extrabold text-gray-800 mb-2">Welcome Class!</h2>
                    <p class="text-sm text-gray-600 mb-4">
                        This centralized hub is designed for 11-STEM J1b to track all subjects, view important announcements, and manage study materials.
                    </p>
                </div>

                <!-- Announcements Section -->
                <div class="section-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                        Important Announcements
                        <button id="add-announcement-btn" class="hidden text-sm font-semibold px-3 py-1 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-colors" onclick="showModal('announcement-modal')">
                            <i data-lucide="plus" class="w-4 h-4 inline-block mr-1"></i> Add
                        </button>
                    </h2>
                    
                    <div id="announcement-list" class="space-y-4">
                        <!-- Announcements will be loaded here -->
                        <div id="loading-announcements" class="text-center py-8 text-gray-500">
                            <i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto mb-2"></i> Loading Announcements...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Subjects (1/3 on Desktop) -->
            <div class="lg:col-span-1">
                <div class="section-card p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                        Subjects
                        <button id="add-subject-btn" class="hidden text-sm font-semibold px-3 py-1 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-colors" onclick="showModal('subject-modal')">
                            <i data-lucide="plus" class="w-4 h-4 inline-block mr-1"></i> Add
                        </button>
                    </h2>
                    
                    <div id="subject-list" class="space-y-3">
                        <!-- Subjects will be loaded here -->
                        <div id="loading-subjects" class="text-center py-8 text-gray-500">
                            <i data-lucide="loader" class="w-6 h-6 animate-spin mx-auto mb-2"></i> Loading Subjects...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Modals -->
    <!-- Reusable Modal Structure (Hidden by default) -->
    <div id="announcement-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md m-4 transform transition-transform duration-300 scale-95">
            <h3 id="announcement-modal-title" class="text-xl font-bold mb-4 text-gray-800">Add New Announcement</h3>
            <form id="announcement-form">
                <input type="hidden" id="announcement-id">
                <div class="mb-4">
                    <label for="announcement-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="announcement-title" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="announcement-content" class="block text-sm font-medium text-gray-700 mb-1">Details</label>
                    <textarea id="announcement-content" rows="4" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors" onclick="hideModal('announcement-modal')">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors">Save Announcement</button>
                </div>
            </form>
        </div>
    </div>

    <div id="subject-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md m-4 transform transition-transform duration-300 scale-95">
            <h3 id="subject-modal-title" class="text-xl font-bold mb-4 text-gray-800">Add New Subject</h3>
            <form id="subject-form">
                <input type="hidden" id="subject-id">
                <div class="mb-4">
                    <label for="subject-name" class="block text-sm font-medium text-gray-700 mb-1">Subject Name (e.g., Mathematics)</label>
                    <input type="text" id="subject-name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="subject-teacher" class="block text-sm font-medium text-gray-700 mb-1">Teacher</label>
                    <input type="text" id="subject-teacher" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="subject-status" class="block text-sm font-medium text-gray-700 mb-1">Status/Project</label>
                    <input type="text" id="subject-status" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Final Project Due Next Week" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors" onclick="hideModal('subject-modal')">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors">Save Subject</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Login/Auth Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm m-4 transform transition-transform duration-300 scale-95">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Admin Login</h3>
            <p class="text-sm text-red-500 mb-4">You need to be logged in as an Admin to make changes.</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <!-- IMPORTANT: The default Admin account must be created in your Firebase Console Auth tab first! -->
                    <input type="email" id="login-email" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" value="admin@j1bstem.edu" required>
                </div>
                <div class="mb-4">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" value="admin123" required>
                </div>
                <div id="login-error-message" class="text-red-500 text-sm mb-4 hidden"></div>
                <div class="flex justify-end space-x-3">
                    <button type="button" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors" onclick="hideModal('login-modal')">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors">Log In</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION (PASTED FROM YOUR CONSOLE) ---
        // This is your live, unique, and secure configuration.
        const firebaseConfig = {
            apiKey: "AIzaSyDFAnoQMRalQbmmIcQTtfEFcDEzmo1VfPg",
            authDomain: "j1b-stem-hub.firebaseapp.com",
            projectId: "j1b-stem-hub",
            storageBucket: "j1b-stem-hub.firebasestorage.app",
            messagingSenderId: "675941167620",
            appId: "1:675941167620:web:3b694c9657e1e56f7fbb51"
            // measurementId: "G-F0N1RF374X" // Removed analytics for simplicity
        };
        
        // --- ADMIN UID CONFIGURATION ---
        // Once you create the admin user (e.g., admin@j1bstem.edu / admin123) in Firebase,
        // sign in and check the console (or Firebase Auth tab) for the UID. 
        // Replace the placeholder UID below with the actual UID of your admin user.
        // The first user you create with the default credentials will be the admin.
        const ADMIN_UIDS = []; // Will be populated when the admin signs in for the first time
        
        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Global state for user and admin status
        let currentUser = null;
        let isAdmin = false;

        // --- UTILITY FUNCTIONS ---

        /**
         * Shows a modal overlay by updating its CSS classes.
         * @param {string} id - The ID of the modal element.
         */
        window.showModal = function(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }
        }

        /**
         * Hides a modal overlay by updating its CSS classes.
         * @param {string} id - The ID of the modal element.
         */
        window.hideModal = function(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.querySelector('div').classList.add('scale-95');
                modal.querySelector('div').classList.remove('scale-100');
                modal.classList.add('opacity-0', 'pointer-events-none');
            }
        }
        
        /**
         * Renders the authentication UI (Login button or User status/Logout).
         */
        function renderAuthUI() {
            const authUi = document.getElementById('auth-ui');
            authUi.innerHTML = ''; // Clear existing UI
            
            if (currentUser) {
                const userElement = document.createElement('div');
                userElement.className = 'text-right';
                
                let userStatus = '';
                if (isAdmin) {
                    userStatus = `<span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-600">
                                    <i data-lucide="shield-check" class="w-3 h-3 mr-1"></i> ADMIN
                                  </span>`;
                } else {
                    userStatus = `<span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-600">
                                    VIEWER
                                  </span>`;
                }

                userElement.innerHTML = `
                    <p class="text-xs text-gray-500 truncate">${currentUser.email || 'Anonymous User'}</p>
                    ${userStatus}
                    <button id="logout-btn" class="text-xs text-indigo-500 hover:text-indigo-700 transition-colors mt-1" onclick="handleLogout()">Log out</button>
                `;
                authUi.appendChild(userElement);
                
                // Show/hide admin buttons
                document.getElementById('add-announcement-btn').classList.toggle('hidden', !isAdmin);
                document.getElementById('add-subject-btn').classList.toggle('hidden', !isAdmin);
                
            } else {
                const loginButton = document.createElement('button');
                loginButton.id = 'login-trigger';
                loginButton.className = 'px-4 py-2 text-sm font-medium bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors';
                loginButton.textContent = 'Admin Login';
                loginButton.onclick = () => showModal('login-modal');
                authUi.appendChild(loginButton);
                
                // Hide admin buttons
                document.getElementById('add-announcement-btn').classList.add('hidden');
                document.getElementById('add-subject-btn').classList.add('hidden');
            }
            
            // Re-render Lucide icons
            lucide.createIcons();
        }


        // --- FIREBASE AUTHENTICATION HANDLERS ---
        
        /**
         * Handles user login with email and password.
         */
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorElement = document.getElementById('login-error-message');
            errorElement.classList.add('hidden');

            try {
                // Sign in with email and password
                await signInWithEmailAndPassword(auth, email, password);
                
                // If sign-in is successful, onAuthStateChanged will handle the rest.
                hideModal('login-modal');
            } catch (error) {
                // Handle errors like wrong password or email
                errorElement.textContent = `Login Failed: ${error.message}`;
                errorElement.classList.remove('hidden');
                console.error("Login error:", error);
            }
        }
        
        /**
         * Handles user logout.
         */
        window.handleLogout = async function() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
            }
        }

        /**
         * Sets up the real-time listener for authentication status.
         */
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            isAdmin = false;
            
            // If user is logged in, check if their UID is an admin
            if (user) {
                // NOTE: This is where we check if the signed-in user's UID is in our ADMIN_UIDS array.
                // For the first time, if they are the admin, we add them to the array for future use.
                // In a production environment, you would use Firestore security rules for this.
                if (ADMIN_UIDS.includes(user.uid) || ADMIN_UIDS.length === 0) {
                    isAdmin = true;
                    if (!ADMIN_UIDS.includes(user.uid)) {
                        ADMIN_UIDS.push(user.uid); // Add the first logged-in user as Admin if list is empty
                        console.log("Welcome Admin! Your UID has been registered for this session:", user.uid);
                    }
                }
            }
            
            // Render the UI based on the new auth state
            renderAuthUI();
        });


        // --- FIRESTORE DATA RENDERERS ---

        /**
         * Renders the list of subjects.
         * @param {Array} subjects - Array of subject objects.
         */
        function renderSubjects(subjects) {
            const subjectList = document.getElementById('subject-list');
            subjectList.innerHTML = '';
            document.getElementById('loading-subjects').classList.add('hidden');

            if (subjects.length === 0) {
                subjectList.innerHTML = `<p class="text-gray-500 text-center py-4">No subjects added yet.</p>`;
                return;
            }

            subjects.forEach(subject => {
                const item = document.createElement('div');
                item.className = 'p-3 border border-gray-100 bg-gray-50 rounded-lg shadow-sm';
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h4 class="text-lg font-semibold text-gray-800">${subject.name}</h4>
                        <div class="flex space-x-2 ${isAdmin ? '' : 'hidden'}">
                            <button class="text-indigo-500 hover:text-indigo-700" onclick="editSubject('${subject.id}', '${subject.name}', '${subject.teacher}', '${subject.status}')">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700" onclick="deleteSubject('${subject.id}', '${subject.name}')">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">Teacher: ${subject.teacher}</p>
                    <p class="text-sm font-medium text-indigo-500 mt-2">Status: ${subject.status}</p>
                `;
                subjectList.appendChild(item);
            });
            lucide.createIcons();
        }

        /**
         * Renders the list of announcements.
         * @param {Array} announcements - Array of announcement objects.
         */
        function renderAnnouncements(announcements) {
            const announcementList = document.getElementById('announcement-list');
            announcementList.innerHTML = '';
            document.getElementById('loading-announcements').classList.add('hidden');

            if (announcements.length === 0) {
                announcementList.innerHTML = `<p class="text-gray-500 text-center py-4">No announcements posted yet.</p>`;
                return;
            }

            announcements.forEach(announcement => {
                const date = announcement.timestamp ? new Date(announcement.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                
                const item = document.createElement('div');
                item.className = 'p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg shadow-sm';
                item.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div>
                            <h4 class="text-xl font-bold text-gray-800">${announcement.title}</h4>
                            <p class="text-xs text-gray-500 mt-1">Posted: ${date}</p>
                        </div>
                        <div class="flex space-x-2 ${isAdmin ? '' : 'hidden'}">
                            <button class="text-indigo-500 hover:text-indigo-700" onclick="editAnnouncement('${announcement.id}', '${announcement.title}', \`${announcement.content.replace(/'/g, "\\'")}\`)">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button class="text-red-500 hover:text-red-700" onclick="deleteAnnouncement('${announcement.id}', '${announcement.title}')">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700 whitespace-pre-wrap mt-3">${announcement.content}</p>
                `;
                announcementList.appendChild(item);
            });
            lucide.createIcons();
        }


        // --- FIRESTORE CRUD HANDLERS (ADMIN ONLY) ---
        
        /**
         * Prepares the subject modal for editing an existing subject.
         */
        window.editSubject = function(id, name, teacher, status) {
            if (!isAdmin) return;
            document.getElementById('subject-id').value = id;
            document.getElementById('subject-name').value = name;
            document.getElementById('subject-teacher').value = teacher;
            document.getElementById('subject-status').value = status;
            document.getElementById('subject-modal-title').textContent = 'Edit Subject';
            showModal('subject-modal');
        }

        /**
         * Deletes a subject document from Firestore.
         */
        window.deleteSubject = async function(id, name) {
            if (!isAdmin) return;
            if (confirm(`Are you sure you want to delete the subject: ${name}?`)) {
                try {
                    await deleteDoc(doc(db, "subjects", id));
                    console.log("Subject successfully deleted!");
                } catch (e) {
                    console.error("Error deleting subject: ", e);
                }
            }
        }
        
        /**
         * Prepares the announcement modal for editing an existing announcement.
         */
        window.editAnnouncement = function(id, title, content) {
            if (!isAdmin) return;
            document.getElementById('announcement-id').value = id;
            document.getElementById('announcement-title').value = title;
            // Use decodeURIComponent for content that might have been escaped
            document.getElementById('announcement-content').value = content;
            document.getElementById('announcement-modal-title').textContent = 'Edit Announcement';
            showModal('announcement-modal');
        }

        /**
         * Deletes an announcement document from Firestore.
         */
        window.deleteAnnouncement = async function(id, title) {
            if (!isAdmin) return;
            if (confirm(`Are you sure you want to delete the announcement: ${title}?`)) {
                try {
                    await deleteDoc(doc(db, "announcements", id));
                    console.log("Announcement successfully deleted!");
                } catch (e) {
                    console.error("Error deleting announcement: ", e);
                }
            }
        }

        /**
         * Handles saving (add/edit) for subjects.
         */
        document.getElementById('subject-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin) return;
            
            const id = document.getElementById('subject-id').value;
            const name = document.getElementById('subject-name').value;
            const teacher = document.getElementById('subject-teacher').value;
            const status = document.getElementById('subject-status').value;

            const subjectData = {
                name,
                teacher,
                status
            };

            try {
                if (id) {
                    // Update existing subject
                    await updateDoc(doc(db, "subjects", id), subjectData);
                    console.log("Subject updated successfully!");
                } else {
                    // Add new subject
                    await addDoc(collection(db, "subjects"), subjectData);
                    console.log("New subject added successfully!");
                }
                hideModal('subject-modal');
                e.target.reset(); // Clear form
            } catch (e) {
                console.error("Error saving subject: ", e);
            }
        });

        /**
         * Handles saving (add/edit) for announcements.
         */
        document.getElementById('announcement-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isAdmin) return;
            
            const id = document.getElementById('announcement-id').value;
            const title = document.getElementById('announcement-title').value;
            const content = document.getElementById('announcement-content').value;

            const announcementData = {
                title,
                content,
                timestamp: serverTimestamp() // Use Firestore's server timestamp
            };

            try {
                if (id) {
                    // Update existing announcement
                    await updateDoc(doc(db, "announcements", id), announcementData);
                    console.log("Announcement updated successfully!");
                } else {
                    // Add new announcement
                    await addDoc(collection(db, "announcements"), announcementData);
                    console.log("New announcement added successfully!");
                }
                hideModal('announcement-modal');
                e.target.reset(); // Clear form
            } catch (e) {
                console.error("Error saving announcement: ", e);
            }
        });
        
        // Reset modals when they are opened for a new item
        document.getElementById('add-announcement-btn').addEventListener('click', () => {
            document.getElementById('announcement-form').reset();
            document.getElementById('announcement-id').value = '';
            document.getElementById('announcement-modal-title').textContent = 'Add New Announcement';
        });
        
        document.getElementById('add-subject-btn').addEventListener('click', () => {
            document.getElementById('subject-form').reset();
            document.getElementById('subject-id').value = '';
            document.getElementById('subject-modal-title').textContent = 'Add New Subject';
        });

        // --- FIRESTORE REAL-TIME LISTENERS ---
        
        // 1. Listen for Subjects changes
        const subjectsQuery = collection(db, "subjects");
        onSnapshot(subjectsQuery, (snapshot) => {
            const subjects = [];
            snapshot.forEach((doc) => {
                subjects.push({ id: doc.id, ...doc.data() });
            });
            // NOTE: Sorting is done in memory to avoid needing Firestore indexes.
            subjects.sort((a, b) => a.name.localeCompare(b.name));
            renderSubjects(subjects);
        }, (error) => {
            console.error("Error fetching subjects:", error);
            document.getElementById('loading-subjects').textContent = 'Failed to load subjects.';
        });

        // 2. Listen for Announcements changes
        // Order by timestamp descending (newest first)
        const announcementsQuery = query(collection(db, "announcements"));
        onSnapshot(announcementsQuery, (snapshot) => {
            const announcements = [];
            snapshot.forEach((doc) => {
                announcements.push({ id: doc.id, ...doc.data() });
            });
            // NOTE: Sorting is done in memory to avoid needing Firestore indexes.
            announcements.sort((a, b) => {
                const timeA = a.timestamp ? a.timestamp.seconds : 0;
                const timeB = b.timestamp ? b.timestamp.seconds : 0;
                return timeB - timeA; // Descending order
            });
            renderAnnouncements(announcements);
        }, (error) => {
            console.error("Error fetching announcements:", error);
            document.getElementById('loading-announcements').textContent = 'Failed to load announcements.';
        });
        
        // --- INITIAL SETUP ---
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        lucide.createIcons(); // Initialize Lucide icons on load

    </script>
</body>
</html>

